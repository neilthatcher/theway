<!doctype html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="cache-control" content="no-cache" />  
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="pragma" content="no-cache" />
  
  <title>AcademyApp</title>
  <meta name="description" content="AcademyApp">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.parsecdn.com/js/parse-1.3.1.min.js"></script>
</head>

<body>
  <div class="row">
      <div>
        <a href="signup.html">SIGN-UP</a>
        <a href="signin.html">SIGN-IN</a>
        <a href="createClass.html">CREATE_CLASS</a>
        <a href="event_list.html">EVENT_LIST</a>
        <a href="editMember.html">MEMBER_EDIT</a>
      </div>
  </div>
  <hr/> 

  <div id="main">
    <h1>The Way Taekwondo</h1>
    <h3>Member Edit Form</h3>

    <div class="row">
      <div class="span2"><input type="text" id="searchLastname" placeholder="search by lastname"><button onclick="searchByLastname()">SEARCH</button></div>
    </div>

    <div class="row">
      <table id="searchResult" border="1">
      </table>
    </div>
    
    <div><hr/>
      <div class="row" id="msg"></div>
      <hr/></div>

    <div class="row">
      <div class="span2">Upload Picture</div>
      <div><input type="file" id="picture"></div>
    </div>

    <div class="row">
      <div class="span2">First Name:</div><div>
      <input id="firstname" type="text">*</div>
    </div>

    <div class="row">
      <div class="span2">Last Name:</div><div>
        <input id="lastname" type="text">**</div>
    </div>

    <div class="row">
      <div class="span2">Date of birth:</div><div>
        <input id="dateofbirth" type="date"/></div>
    </div>

    <div class="row">
      <div class="span2">Address:</div><div>
        <input id="address" type="text"></div>
    </div>

    <div class="row">
      <div class="span2">City:</div><div>
        <input id="city" type="text"></div>
    </div>

    <div class="row">
      <div class="span2">State:</div><div>
        <input id="state" type="text"></div>
    </div>

    <div class="row">
      <div class="span2">Zip:</div><div>
        <input id="zip" type="text"></div>
    </div>

    <div class="row">
      <div class="span2">Phone:</div><div>
        <input id="phone" type="text"></div>
    </div>

    <div class="row">
      <div class="span2">Email:</div><div>
        <input id="email" type="text"></div>
    </div>

    <div class="row">
      <div class="span2">Marital Status:</div><div>
        <select id="maritalstatus">
          <option value="SINGLE">SINGLE</option>
          <option value="MARRIED">MARRIED</option>
        </select></div>
    </div>

    <div class="row">
      <div class="span2">Gender:</div><div>
        <select id="gender">
          <option value="MALE">MALE</option>
          <option value="FEMALE">FEMALE</option>
        </select></div>
    </div>

    <div class="row">
      <div class="span2">Family Code:</div><div>
        <input id="familyCode" type="text"></div>
    </div>


    <div class="row">
      <div class="span2">Occupation:</div><div>
        <input id="occupation" type="text"></div>
    </div>

    <div class="row">
      <div class="span2">CurrentBelt:</div><div><select id="currentBelt">
        <option value="NONE">NONE</option>
        <option value="WHITE">WHITE</option>
        <option value="YELLOW">YELLOW</option>
        <option value="GOLD">GOLD</option>
        <option value="ORANGE">ORANGE</option>
        <option value="GREEN">GREEN</option>
        <option value="PURPLE">PURPLE</option>
        <option value="BLUE">BLUE</option>
        <option value="RED">RED</option>
        <option value="BROWN">BROWN</option>
        <option value="BROWN/BLACK">BROWN/BLACK</option>
        <option value="BLACK_1">BLACK_1</option>
        <option value="BLACK_2">BLACK_2</option>
        <option value="BLACK_3">BLACK_3</option>
        <option value="BLACK_4">BLACK_4</option>
        <option value="BLACK_5">BLACK_5</option>
        <option value="BLACK_6">BLACK_6</option>
        <option value="BLACK_7">BLACK_7</option>
        <option value="BLACK_8">BLACK_8</option>
        <option value="BLACK_9">BLACK_9</option>
    </select></div>
    </div>

    <div class="row">
      <div class="span2">Has Waiver</div>
      <div><input type="checkbox" id="waiver"></div>
    </div>


    <div class="row" id="msg"></div>
    <div class="row"><button onclick="saveForm()">Submit </button><button onclick="reset()">Reset </button></div>
    <button onclick="logout()">Logout</button>
  </div>

  <script type="text/javascript">
    Parse.initialize("qhJKJHGivO5op9dvRGxYXNr7Xjx3ru3hpDKXw9G0", "Xyov0zQSe7syEvlMgkUdUmKlQ1S9eQcq485MEqaG");

    var memberList = {};
    var memberBeingEdited = "";

    function reset(){
      $( "#firstname" ).val("");
      $( "#lastname" ).val("");
      $( "#address" ).val("");
      $( "#dateofbirth" ).val("");
      $( "#city" ).val("");
      $( "#state" ).val("");
      $( "#zip" ).val("");
      $( "#phone" ).val("");
      $( "#email" ).val("");
      $( "#maritalstatus" ).val("");
      $( "#gender" ).val("");
      $( "#occupation" ).val("");
    }

    function saveForm(){

      // validate that the main fields are completed
      if($("#firstname").length > 0 && $("#lastname").length > 0 & $("#address").length > 0)
      var member = memberList[memberBeingEdited];
      member.save({firstname: $( "#firstname" ).val().toUpperCase(), lastname: $( "#lastname" ).val().toUpperCase(), 
        address: $( "#address" ).val().toUpperCase(), dateOfBirth: $( "#dateofbirth" ).val(),
        city:  $( "#city" ).val().toUpperCase(), state: $( "#state" ).val().toUpperCase(),
        zip:  $( "#zip" ).val(), phone: $( "#phone" ).val(),
        email:  $( "#email" ).val().toUpperCase(), maritalStatus: $( "#maritalstatus" ).val(),
        gender:  $( "#gender" ).val(), occupation: $( "#occupation" ).val(), familyCode: $( "#familyCode").val(),
        academyId: '1', currentBelt : $('#currentBelt').val()
      }, {
            success: function(object) {
              $(".success").show();
              // alert("data stored!");
              showMsg("Data updated!", "");
            },
            error: function(model, error) {
              $(".error").show();
              // alert(error.message);
              showMsg(error.message, "err");
            }}); 

    }

  function searchByLastname(){
    reset();
    $("#msg").empty();
    showMsg("Searching...","");
    $("#searchResult").empty();
    $("#searchResult").append("<tr><th>Count</th><th>Firstname</th><th>Lastname</th><th>Belt</th><th>FamilyCode</th><th>Profile</th></tr>");
    var Member = Parse.Object.extend("Member");
    var query = new Parse.Query(Member);
    query.startsWith("lastname", $("#searchLastname").val().toUpperCase());
    query.find({
      success: function(results) {
        for (var i = 0; i < results.length; i++) { 
          var tt = results[i].id;
          memberList[results[i].id] = results[i];
          var data = "<tr><td>" + (i+1) + "</td><td>" + results[i].get('firstname') + "</td><td>" + results[i].get('lastname') + "</td><td>" + results[i].get('currentBelt') + "</td><td>" + results[i].get('familyCode') + "</td><td><a href='#' onclick='populateFieldsForEdit(\"" + results[i].id + "\")'>View</a></td></tr>";
          $("#searchResult").append(data);
          showMsg("","");
        }              
      },
      error: function(error) {
        // alert("Error: " + error.code + " " + error.message);
        showMsg(error.message, "err");
      }
    });
  }

  function populateFieldsForEdit(memberId){
      showMsg("", "");
      var memberToEdit = memberList[memberId];
      memberBeingEdited = memberId;

      // var bb = new Date(Date.parse(memberToEdit.get("dateOfBirth")));
      
      var year = memberToEdit.get("dateOfBirth").slice(0,4);
      var month = memberToEdit.get("dateOfBirth").slice(5,7);
      var day = memberToEdit.get("dateOfBirth").slice(8,10);
      var birthday = year + '-' + month + '-' + day;
      $( "#firstname" ).val( memberToEdit.get("firstname") );
      $( "#lastname" ).val( memberToEdit.get("lastname") );
      $( "#address" ).val( memberToEdit.get("address") );
      $( "#dateofbirth" ).val( birthday );
      $( "#city" ).val( memberToEdit.get("city") );
      $( "#state" ).val( memberToEdit.get("state") );
      $( "#zip" ).val( memberToEdit.get("zip") );
      $( "#phone" ).val( memberToEdit.get("phone") );
      $( "#email" ).val( memberToEdit.get("email") );
      $( "#maritalstatus" ).val( memberToEdit.get("maritalStatus") );
      $( "#gender" ).val( memberToEdit.get("gender") );
      $( "#familyCode" ).val( memberToEdit.get("familyCode") );
      $( "#occupation" ).val( memberToEdit.get("occupation") );
      $( "#currentBelt" ).val( memberToEdit.get("currentBelt") );
         
  }

  function logout(){
    Parse.User.logOut();
  }


  function showMsg(message, type){
    $("#msg").empty();
    msgStyle = "color:black; font-weight:bold;";
    if(type == "err"){
      msgStyle = "color:red; font-weight:bold;";
    }
    $("#msg").append("<p style='"+msgStyle+"'>"+message+"</p>");
  }

  // Numeric only control handler
    jQuery.fn.ForceNumericOnly =
    function()
    {
        return this.each(function()
        {
            $(this).keydown(function(e)
            {
                var key = e.charCode || e.keyCode || 0;
                // allow backspace, tab, delete, enter, arrows, numbers and keypad numbers ONLY
                // home, end, period, and numpad decimal
                return (
                    key == 8 || 
                    key == 9 ||
                    key == 13 ||
                    key == 46 ||

                    key == 110 ||
                    key == 190 ||
                    (key >= 35 && key <= 40) ||
                    (key >= 48 && key <= 57) ||
                    (key >= 96 && key <= 105));
            });
        });
    };

    $("#zip").ForceNumericOnly();
    $("#phone").ForceNumericOnly();
    $("#familyCode").ForceNumericOnly();

  var currentUser = Parse.User.current();
  if (!currentUser) {
    window.location.href = "index.html"
  }
  </script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/jquery-2.1.0.min.js"></script>
</body>

</html>
