<!doctype html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="cache-control" content="no-cache" />  
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="pragma" content="no-cache" />
  <title>AcademyApp</title>
  <meta name="description" content="AcademyApp">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.parsecdn.com/js/parse-1.3.1.min.js"></script>
  <script src="js/setnow.jquery.js"></script>
</head>

<body>
    <div class="row">
      <div>
	  <table align="Center">
	  <tr><td>
        <a href="signup.html">SIGN-UP</a>
		 | 
        <a href="signin.html">SIGN-IN</a>
		 | 
        <a href="createClass.html">CREATE_CLASS</a>
		 | 
        <a href="event_list.html">EVENT_LIST</a>
		 | 
        <a href="editMember.html">MEMBER_EDIT</a>
		</td>
		</tr>
		</table>
      </div>
  </div>
  <hr/> 

  <div id="main" style="padding-top:0px padding-right:0px padding-bottom:0px padding-left:0px">

    <h1>The Way CTU <image id="my_image" src="img/upclogo.jpg" alt="image error" align="right"></image></h1>
    <h3>Signing In Page</h3>

    <div id class="row">
    <h3 class="row" id="messages"></h3>
    </div>

    <div class="row">
      <div>Class Date</div>
      <div><input type="date" id="txtDate" onblur="getEvents();"></div>

      <div>Please provide your family Code</div>
      <div><input type="text" id="familyCode" name="familyCode"></div>
      <div>
        <button onclick="search()">Search</button>
        <button onclick="reset()">Reset</button>
      </div>
    </div>
    <hr/>
    <div class="row" id="msg"></div>
    <hr/>
    <div class="members">
        <div class="row">Members to register</div>

        <div class="row">
            <table id="members" border="1"></table>
        </div>
        
        <div>
            <button onclick="save()">Save</button>
        </div>
    </div>
  </div>
</body>


<script type="text/javascript" src="js/date.js"></script>
<script type="text/javascript">
    Parse.initialize("qhJKJHGivO5op9dvRGxYXNr7Xjx3ru3hpDKXw9G0", "Xyov0zQSe7syEvlMgkUdUmKlQ1S9eQcq485MEqaG");
    var todayClasses;
    var todayRegisteredVisits = {};

    var todayClassesMap = {}; // user for mapping matching for delete or add
    var todayClassesArr = []; // user for query visits

    var membersMap = {}; // used for mapping matching for delete or add
    var membersArr = []; // used for query visits

    var relationsToStore = {};
    var processed = []; // used to count how many transactions have been processed
    var toProcessCounter = 0;

    var beginDay; // used to query the backend database
    var endDay;

    var now = new Date();
    var day = ("0" + now.getDate()).slice(-2);
    var month = ("0" + (now.getMonth() + 1)).slice(-2);
    var today = now.getFullYear()+"-"+(month)+"-"+(day) ;
    $('#txtDate').val(today);

    function reset(){
      $( "#familyCode" ).val("");
    } 


    function getEvents(){
      todayClassesMap = {};
      todayClassesArr = [];
      
      beginDay = Date.parse($("#txtDate").val());
      endDay = new Date( beginDay ).add(1).day();
      var Event = Parse.Object.extend("Event");
      var query = new Parse.Query(Event);
      query.greaterThan("date", beginDay);
      query.lessThan("date", endDay);
      query.find({
        success: function(results){
          todayClasses = results;
          if(results.length == 0){
            showMsg("no classes registered for today!");
          }else{
            for(var x = 0; x < results.length; x++){
              todayClassesMap[results[x].id] = results[x];
              todayClassesArr[x] = results[x];
            }
            showMsg(results.length + " classes found! ");
          }
        },
        error: function(error){
          alert("fail");
        }
      });

    }

    function search(){ // search for members using family code
      todayRegisteredVisits = {};
      relationsToStore = {};
      processed = [];
      membersMap = {};
      membersArr = []; //temp
      if(todayClasses.length == 0){
        showMsg("Please create a class for today!");
        $(location).attr('href',"createClass.html");
      }else{
        showMsg("Searching ...", null);
        // search for members with this family code
        $("#members").empty();
        var Member = Parse.Object.extend("Member");
        var query = new Parse.Query(Member);
        query.equalTo("familyCode", $("#familyCode").val());
        query.ascending("firstname");
        query.find({
          success: function(results) {
            for (var i = 0; i < results.length; i++) { 
              membersMap[results[i].id] = results[i]; // store member in map
              membersArr[i] = results[i];
            }
            getRegisteredVisits();
            showMsg(results.length+" members found", null);
        },
          error: function(error) {
            showMsg(error.message, "err");
          }
        }); 
      }
    }

    // get all registered visits for the events of the day selected
    // for the specific members found
    function getRegisteredVisits(){
      todayRegisteredVisits = {};

      var Visit = Parse.Object.extend("Visit");
      var query = new Parse.Query(Visit);
      query.containedIn("member", membersArr);
      query.containedIn("event", todayClassesArr);
      query.descending("member,event");
      query.find({
        success: function(results){
          if(results.length > 0){
            var memberAssistedClasses = ""; // holder for html render of table of visits

            for(var x = 0; x < results.length; x++){
              // register visit using the memberId+eventId as hashkey for easy retrieval
              todayRegisteredVisits[results[x].get("member").id + results[x].get("event").id] = results[x];
            }
          }
          refreshTableMemberVisit();
        },
        error: function(error){
          alert("fail" + error.message);
        }
      });

    }

    function refreshTableMemberVisit(){
      for(var x = 0; x < membersArr.length; x++){
        // create line with member name
        var currentMember = membersArr[x]
        var memberLine = "<tr><th colspan=2>" + currentMember.get("firstname") + "</th></tr>";
        $("#members").append(memberLine);
        // iterate through classes for the day
        for(var y = 0; y < todayClassesArr.length; y++){
          // check if there is a registered visit for this member and this class and mark class
          var currentClass = todayClassesArr[y];
          // var test = todayRegisteredVisits[currentMember.id + currentClass.id];
          var registered = "";
          if(todayRegisteredVisits[currentMember.id + currentClass.id]){
            registered = "checked";
          }
          var memberClassLine = "<tr class='unsel' id='"+currentMember.id+currentClass.id+"' onclick=\"memberEventOptionClicked('" + currentMember.id + "', '" + currentClass.id + "')\"><td ><input type='checkbox' " + registered + ">" +
             currentClass.get("location")  + "</td><td>" + currentClass.get("Type") + "</td></tr>";
          $("#members").append(memberClassLine);
        }
        
      }
    }

    // function memberEventOptionClicked(checkboxId, memberId, eventId){
    function memberEventOptionClicked(memberId, eventId){
      // console.log("" + memberId + " -> " + eventId);
      // var tt = todayRegisteredVisits[memberId + eventId];
      
      // if the combination is on todayRegisteredVisits add to the list of ToDelete
      transType = "add";
      if(todayRegisteredVisits[memberId + eventId] === undefined){
        // console.log("toAdd");
      }else{
        // toDelete
        transType = "delete";
      }
      
      if( relationsToStore[memberId + eventId] === undefined ){
        // add object to be added or deleted
         document.getElementById(memberId + eventId).className = "sel";
        var data = {memId: memberId, evtId: eventId, type: transType};
        relationsToStore[memberId + eventId] = data;
      }else{
        // remove object from map, user decide not to modify
        delete relationsToStore[memberId + eventId];
        document.getElementById(memberId + eventId).className = "unsel"
      }

      // if(document.getElementById(memberId + eventId).className == "unsel"){
      // }else{
      // }
    }

    // store the assistance on the table visit
    function save(){
      toProcessCounter = 0;
      for( var toProcess in relationsToStore ){  
          toProcessCounter++;
          var Visit = Parse.Object.extend("Visit");
          var visit = new Visit();
          var data = relationsToStore[ toProcess ];
          var today = Date.today()
          if(data.type == 'add'){
              visit.save({event: todayClassesMap[data.evtId], member: membersMap[data.memId], visitDate: today, belt: membersMap[data.memId].get("currentBelt"), firstname: membersMap[data.memId].get("firstname"), lastname: membersMap[data.memId].get("lastname"), hours: todayClassesMap[data.evtId].get("hours") }, 
              {
                    success: function(object) {
                      processed.push(1);
                      showMsg("Data saved", "multi");
                    },
                    error: function(model, error) {
                      processed.push(1);
                      showMsg(error.message, "err");
                    }});
          }else{
            var visitToDestroy = todayRegisteredVisits[data.memId + data.evtId];
            delete todayRegisteredVisits[data.memId + data.evtId];
            visitToDestroy.destroy( {
              success: function(object) {
                  processed.push(1);
                  showMsg("Data updated", "multi");

              },
              error: function(model, error){
                processed.push(1);
                showMsg(error.message, "err");
              }
            });
          } 
      }
    }

    function showMsg(message, type){
      $("#msg").empty();
      msgStyle = "color:black; font-weight:bold;";
      if(type == "err"){
        msgStyle = "color:red; font-weight:bold;";
      }

      if(type == "multi"){
        $("#msg").append("Processing " + processed.length + " / " + toProcessCounter);
        if(processed.length == toProcessCounter){
            $("#msg").append("<br>transaction finished");
            processed = [];
            // relationsToStore = new Array();
            search();
        }
      }else{
        $("#msg").append("<p style='"+msgStyle+"'>"+message+"</p>");
      }
    }

    getEvents();

     jQuery.fn.ForceNumericOnly =
    function()
    {
        return this.each(function()
        {
            $(this).keydown(function(e)
            {
                var key = e.charCode || e.keyCode || 0;
                // allow backspace, tab, delete, enter, arrows, numbers and keypad numbers ONLY
                // home, end, period, and numpad decimal
                return (
                    key == 8 || 
                    key == 9 ||
                    key == 13 ||
                    key == 46 ||

                    key == 110 ||
                    key == 190 ||
                    (key >= 35 && key <= 40) ||
                    (key >= 48 && key <= 57) ||
                    (key >= 96 && key <= 105));
            });
        });
    };

    $("#familyCode").ForceNumericOnly();
</script>
</html>
