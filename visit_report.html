<!doctype html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="cache-control" content="no-cache" />  
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="pragma" content="no-cache" />
  <title>AcademyApp</title>
  <meta name="description" content="AcademyApp">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="https://www.parsecdn.com/js/parse-1.3.1.min.js"></script>
  <script src="js/setnow.jquery.js"></script>
</head>
<body>
    <div class="row">
      <div>
        <a href="signup.html">SIGN-UP</a>
        <a href="signin.html">SIGN-IN</a>
        <a href="createClass.html">CREATE_CLASS</a>
        <a href="event_list.html">EVENT_LIST</a>
        <a href="editMember.html">MEMBER_EDIT</a>
      </div>
  </div>
  <hr/> 

  <div id="main">
  
  	<div><h3>Report Generator</h3></div>
  	<div>FROM: <input type="date" id="from"/></div>
  	<div>TO: <input type="date" id="to"/></div>
  	<div> <button onclick="getRegisteredVisits()">Generate</button></div>
  	<hr/>
  	<div><button onclick="downloadCSV()">Download Report</button></div>
  	<div>
  		<table id="report" border="1">
  			<tr><th>FirstName</th><th>LastName</th><th>VisitName</th><th>Belt</th><th>Hours</th></tr>
  		</table>
  	</div>



  </div>
</body>
<!-- 
	Begin date end date
-->

<script type="text/javascript">
    Parse.initialize("qhJKJHGivO5op9dvRGxYXNr7Xjx3ru3hpDKXw9G0", "Xyov0zQSe7syEvlMgkUdUmKlQ1S9eQcq485MEqaG");
    var resultsArr = [];
  
    // get all registered visits for the events of the day selected
    // for the specific members found
    function getRegisteredVisits(){
      todayRegisteredVisits = {};

	  var yearA = $("#from").val().slice(0,4);
      var monthA = $("#from").val().slice(5,7);
      var dayA = $("#from").val().slice(8,13);
      var beginDay = new Date(yearA, monthA - 1, dayA, 0, 0, 0);
      
	  var yearB = $("#to").val().slice(0,4);
      var monthB = $("#to").val().slice(5,7);
      var dayB = $("#to").val().slice(8,13);
      var endDay = new Date(yearB, monthB - 1, dayB, 0, 0, 0);
      
      var Visit = Parse.Object.extend("Visit");
      var query = new Parse.Query(Visit);
      query.greaterThan("visitDate", beginDay);
      query.lessThan("visitDate", endDay);
      query.find({
        success: function(results){
          if(results.length > 0){
            for(var x = 0; x < results.length; x++){
              // register visit using the memberId+eventId as hashkey for easy retrieval
              	var visitLine = "<tr><td>" + results[x].get("firstname") + "</td><td>" + results[x].get("lastname") + "</td><td>" + results[x].get("event") + "</td><td>" + results[x].get("belt") + "</td><td>" + results[x].get("hours") + "</td>";
          		$("#report").append(visitLine);
            	resultsArr[x] = results[x].get("firstname") + "," + results[x].get("lastname") + "," + results[x].get("visitDate") + "," + results[x].get("belt") + "," + results[x].get("hours") + "\n";
            }
          }
        },
        error: function(error){
          alert("fail" + error.message);
        }
      });

    }

    function downloadCSV(){
    	var encodedUri = encodeURI(resultsArr);
		var link = document.createElement("a");
		link.setAttribute("href", encodedUri);
		link.setAttribute("download", "my_data.csv");

		link.click(); // This will download the data file named "my_data.csv".
    }

</script>
